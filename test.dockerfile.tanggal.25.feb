# üèóÔ∏è STAGE 1: Build Next.js
FROM node:22 AS builder

WORKDIR /app

# 1Ô∏è‚É£ Copy hanya file penting untuk caching dependensi
COPY package.json yarn.lock ./

# 2Ô∏è‚É£ Install semua dependencies (termasuk devDependencies)
RUN yarn install --frozen-lockfile

# 3Ô∏è‚É£ Copy seluruh kode proyek
COPY . .

# 4Ô∏è‚É£ Build Next.js (output akan ada di `.next`)
RUN yarn build

# üèÉ‚Äç‚ôÇÔ∏è STAGE 2: Production Runtime
FROM node:22 AS runner

WORKDIR /app

# 5Ô∏è‚É£ Install hanya production dependencies (biar lebih kecil)
COPY --from=builder /app/package.json ./
COPY --from=builder /app/yarn.lock ./
RUN yarn install --frozen-lockfile --production=true

# 6Ô∏è‚É£ Copy hasil build & file penting saja
COPY --from=builder /app/.next .next
COPY --from=builder /app/public public

# 7Ô∏è‚É£ Set Environment
ENV NODE_ENV=production
EXPOSE 3000

# 8Ô∏è‚É£ Jalankan Next.js dengan `next start` (lebih cepat dan ringan)
CMD ["yarn", "start"]